{% extends "base.html" %}

{% block content %}
<section class="section-title py-4 bg-light border-bottom">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h1 class="h3 mb-1">YÃ¶netim Paneli</h1>
                <p class="text-muted mb-3">HoÅŸ geldiniz, {{ current_user.username }}! Sistem durumunu buradan yÃ¶netebilirsiniz.</p>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">Ã‡Ä±kÄ±ÅŸ Yap</a>
                <a href="{{ url_for('add_reservation') }}" class="btn btn-primary btn-sm">+ Yeni Telefon Rezervasyonu</a>
                <a href="{{ url_for('add_mission') }}" class="btn btn-info btn-sm">+ Yeni GÃ¶rev Ekle</a>
            </div>
        </div>
        
        <div class="message-area mt-3">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category.replace('message', 'info') }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            {% endif %}
            {% endwith %}
        </div>
    </div>
</section>

<section class="dashboard-content py-4">
    <div class="container">

        <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="reservations-tab" data-toggle="tab" href="#reservations" role="tab">Rezervasyonlar</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="users-tab" data-toggle="tab" href="#users-list" role="tab">MÃ¼ÅŸteriler</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="calendar-tab" data-toggle="tab" href="#calendar" role="tab">Takvim</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="missions-tab" data-toggle="tab" href="#missions-management" role="tab">GÃ¶revler</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="redemptions-tab" data-toggle="tab" href="#redemptions-approval" role="tab">Ã–dÃ¼l Talepleri</a>
            </li>
        </ul>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="reservations" role="tabpanel">
                <h3 class="mb-3 border-bottom pb-2">Aktif ve Gelecek Rezervasyonlar</h3>
                <div class="table-responsive">
                    <table class="table table-hover table-striped dashboard-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Oda No (Atama)</th>
                                <th>Oda Tipi (KullanÄ±lan)</th>
                                <th>Misafir</th>
                                <th>GiriÅŸ</th>
                                <th>Ã‡Ä±kÄ±ÅŸ</th>
                                <th>KiÅŸi</th>
                                <th>Durum</th>
                                <th>Ä°letiÅŸim</th>
                                <th>Oda Ata</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for res in reservations %}
                            <tr class="status-{{ res.status | lower | replace(' ', '-') }}"> 
                                <td>{{ res.id }}</td>
                                
                                {# Oda No (Atama) SÃ¼tunu #}
                                <td>
                                    {% if res.room_type == "Yat KulÃ¼bÃ¼" and res.status not in ['OnaylandÄ±', 'GiriÅŸ YaptÄ±', 'Ã‡Ä±kÄ±ÅŸ YaptÄ±'] %}
                                        <strong class="text-danger fw-bold">ATAMA BEKLÄ°YOR</strong>
                                    {% elif res.room %}
                                        <strong>{{ res.room.room_number }}</strong>
                                    {% else %}
                                        <span class="text-danger fw-bold">AtanmadÄ±</span>
                                    {% endif %}
                                </td>
                                
                                {# Oda Tipi (KullanÄ±lan) SÃ¼tunu #}
                                <td>
                                    {% if res.room_type == "Yat KulÃ¼bÃ¼" %}
                                        <span class="text-info fw-bold">YAT KULÃœBÃœ</span>
                                    {% elif res.room %}
                                        {{ res.room.room_type }}
                                    {% else %}
                                        --
                                    {% endif %}
                                </td>
                                
                                <td>{{ res.guest_name }}</td>
                                <td>{{ res.check_in }}</td>
                                <td>{{ res.check_out }}</td>
                                <td>{{ res.adults }} / {{ res.children }}</td>
                                <td><span class="badge bg-{{ res.status | lower | replace(' ', '-') }}">{{ res.status }}</span></td>
                                <td><a href="tel:{{ res.guest_phone }}" class="text-decoration-none">{{ res.guest_phone }}</a></td>

                                <td>
                                    {# ODA ATAMA KISMI - YAT KULÃœBÃœ ARTIK DAHÄ°L #}
                                    {% if res.status in ['Online Onay Bekliyor', 'Telefon OnaylÄ±', 'Yat KulÃ¼bÃ¼ Talebi (Admin Bekliyor)', 'Yat KulÃ¼bÃ¼ Rezervasyonu'] %}
} 
                                        <div class="d-flex gap-1">
                                            <select id="room-select-{{ res.id }}" class="form-select form-select-sm me-1" style="max-width: 150px;">
    <option value="">Oda seÃ§...</option>
    {% for room in rooms %}
        {% set room_display_name = {
            'STD01':'Oda 1',
            'STD02':'Oda 2',
            'STD03':'Oda 3',
            'STD04':'Oda 4',
            'SUI01':'Suit',
            'PET01':'Oda 7',
            'STD07':'Oda 8',
            'LSU01':'Ãœst Kat'
        }[room.room_number] %}
        <option value="{{ room.id }}" {% if res.room and room.id == res.room.id %}selected{% endif %}>
            {{ room_display_name }}
        </option>
    {% endfor %}
</select>
                                        </div>
                                    {% else %}
                                        
                                        {% if res.room_type == "Yat KulÃ¼bÃ¼" and res.room %}
                                            <small class="text-muted fw-bold">{{ res.room.room_number }}</small> 
                                        {% elif res.room %}
                                            <small class="text-muted">{{ res.room.room_number }}</small>
                                        {% else %}
                                            <small class="text-muted">--</small>
                                        {% endif %}
                                    {% endif %}
                                </td>

                                <td class="text-nowrap">
                                    {% if res.status in ['Online Onay Bekliyor', 'Telefon OnaylÄ±', 'Yat KulÃ¼bÃ¼ Talebi (Admin Bekliyor)'] %} 
                                        <button class="btn btn-success btn-sm" onclick="approveReservation({{ res.id }})">Onayla</button>
                                    {% elif res.status == 'OnaylandÄ±' and res.room_type == 'Yat KulÃ¼bÃ¼' and not res.room %}
                                        {# Yat KulÃ¼bÃ¼ OnaylandÄ± ama oda atanmadÄ±ysa, Onayla butonu tekrar gÃ¶rÃ¼nmeli (room_select ile birlikte) #}
                                        <button class="btn btn-success btn-sm" onclick="approveReservation({{ res.id }})">Oda Ata/Onayla</button>
                                    {% elif res.status == 'OnaylandÄ±' %}
                                        <a href="{{ url_for('update_reservation_status', reservation_id=res.id, new_status='GiriÅŸ YaptÄ±') }}" class="btn btn-primary btn-sm">GiriÅŸ</a>
                                    {% endif %}
                                    
                                    {% if res.status == 'GiriÅŸ YaptÄ±' %}
                                        <a href="{{ url_for('update_reservation_status', reservation_id=res.id, new_status='Ã‡Ä±kÄ±ÅŸ YaptÄ±') }}" class="btn btn-secondary btn-sm">Ã‡Ä±kÄ±ÅŸ</a>
                                    {% endif %}

                                    {% if res.status not in ['Ä°ptal', 'Ã‡Ä±kÄ±ÅŸ YaptÄ±'] %}
                                        <a href="{{ url_for('delete_reservation', reservation_id=res.id) }}" 
                                            onclick="return confirm('{{ res.guest_name }} misafirinin rezervasyonunu kesinlikle silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!')"
                                            class="btn btn-danger btn-sm">Sil/Ä°ptal Et</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="11" class="text-center text-muted py-3">Åu anda aktif veya gelecek bir rezervasyon bulunmamaktadÄ±r.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-pane fade" id="users-list" role="tabpanel">
                <h3 class="mb-3 border-bottom pb-2">Sadakat Sistemi MÃ¼ÅŸterileri</h3>
                <div class="table-responsive">
                    <table class="table table-hover table-striped dashboard-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>KullanÄ±cÄ± AdÄ±</th>
                                <th>E-posta</th>
                                <th>Ad</th>
                                <th>Soyad</th>
                                <th>Toplam Puan</th>
                                <th>KayÄ±t Tarihi</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users_list %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>{{ user.username }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.first_name or 'Yok' }}</td>
                                <td>{{ user.last_name or 'Yok' }}</td>
                                <td><span class="badge bg-info fs-6">{{ user.total_points }}</span></td>
                                <td>{{ user.registered_on.strftime('%d.%m.%Y') if user.registered_on else 'N/A' }}</td>
                                <td class="text-nowrap">
                                    <button class="btn btn-sm btn-outline-primary" title="Puan Ekle/Ã‡Ä±kar">Puan YÃ¶net</button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-3">HenÃ¼z sadakat sistemine kayÄ±tlÄ± mÃ¼ÅŸteri bulunmamaktadÄ±r (Admin hariÃ§).</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-pane fade" id="calendar" role="tabpanel">
                <h3 class="mb-3 border-bottom pb-2">MÃ¼saitlik Takvimi (Oda BazlÄ±)</h3>

                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="prevMonth">â† Ã–nceki Ay</button>
                    <h4 id="currentMonthYear" class="mb-0 text-dark fw-bold"></h4>
                    <button class="btn btn-outline-secondary btn-sm" id="nextMonth">Sonraki Ay â†’</button>
                </div>

                <div id="roomCalendarContainer" class="table-responsive">
                    <div class="alert alert-info" role="alert">Takvim verileri yÃ¼kleniyor...</div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="missions-management" role="tabpanel">
    <h3 class="mb-3 border-bottom pb-2">GÃ¶rev (Mission) YÃ¶netimi</h3>
    <a href="{{ url_for('add_mission') }}" class="btn btn-success btn-sm mb-3">
        <i class="fas fa-plus"></i> Yeni GÃ¶rev Ekle
    </a>
    
    <div class="table-responsive">
        <table class="table table-hover table-striped dashboard-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>BaÅŸlÄ±k</th>
                    <th>AÃ§Ä±klama</th><th>Puan</th>
                    <th>Tipi</th>
                    <th>Tekrar?</th>
                    <th>Durum</th>
                    <th>Ä°ÅŸlemler</th>
                </tr>
            </thead>
            <tbody>
                {% for mission in missions %}
<tr>
    <td>{{ mission.title }}</td>
    <td>{{ mission.description }}</td>
    <td>{{ "YayÄ±nda" if mission.is_active else "Pasif" }}</td>
    <td>
        <a href="{{ url_for('toggle_mission', mission_id=mission.id) }}" 
           class="btn btn-warning btn-sm">
           {% if mission.is_active %} YayÄ±ndan KaldÄ±r {% else %} YayÄ±na Al {% endif %}
        </a>
    </td>
<a href="{{ url_for('delete_mission', mission_id=mission.id) }}" 
   class="btn btn-danger btn-sm"
   onclick="return confirm('Bu gÃ¶revi tamamen silmek istediÄŸinize emin misiniz?');">
   Sil
</a>

</tr>
{% endfor %}

                
            </tbody>
        </table>
    </div>
</div>
            
            <div class="tab-pane fade" id="redemptions-approval" role="tabpanel">
                <h3 class="mb-3 border-bottom pb-2">Ã–dÃ¼l Talep OnaylarÄ±</h3>
                <div class="table-responsive">
                    <table class="table table-hover table-striped dashboard-table">
                        <thead>
                            <tr>
                                <th>Talep ID</th>
                                <th>KullanÄ±cÄ±</th>
                                <th>Ã–dÃ¼l</th>
                                <th>Puan</th>
                                <th>Tarih</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for redemption in pending_redemptions %}
                            <tr>
                                <td>{{ redemption.id }}</td>
                                <td>{{ redemption.user.username }}</td>
                                <td>{{ redemption.reward.title }}</td>
                                <td><span class="badge bg-danger">{{ redemption.points_used }}</span></td>
                                <td>{{ redemption.redemption_date.strftime('%d.%m.%Y') }}</td>
                                <td class="text-nowrap">

    <button class="btn btn-sm btn-outline-primary" title="Puan Ekle/Ã‡Ä±kar">Puan YÃ¶net</button>
    <button class="btn btn-sm btn-outline-success" onclick="sendNotification({{ user.id }})" title="Bildirim GÃ¶nder">Bildirim GÃ¶nder</button>
</td>

                                    <a href="{{ url_for('approve_redemption', redemption_id=redemption.id) }}" class="btn btn-success btn-sm">Onayla</a>
                                    <a href="{{ url_for('reject_redemption', redemption_id=redemption.id) }}" class="btn btn-danger btn-sm">Reddet</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" class="text-center text-muted py-3">Onay bekleyen Ã¶dÃ¼l talebi bulunmuyor.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</section>

<style>
/* TEMEL STÄ°LLER (TEMA RENKLERÄ°NÄ° DEÄÄ°ÅTÄ°RMEDÄ°M) */

/* Genel Tablo Ä°yileÅŸtirmeleri */
.dashboard-table th {
    font-weight: 600;
    background-color: #f8f9fa; /* Hafif arka plan */
}

.dashboard-table td, .dashboard-table th {
    vertical-align: middle;
    padding: 0.75rem 0.5rem; /* Ä°Ã§ dolguyu biraz daralttÄ±m */
}

.text-nowrap td {
    white-space: nowrap;
}

/* Durum Rozetleri (Badgeler) iÃ§in temel stiller */
.badge {
    padding: 0.35em 0.65em;
    font-weight: 700;
    line-height: 1;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
}

/* Duruma Ã¶zel renkler (Bootstrap'in varsayÄ±lan renkleri kullanÄ±lmÄ±ÅŸtÄ±r) */
.status-onaylandÄ± { background-color: #198754 !important; } /* Green */
.status-telefon-onaylÄ±, .status-online-onay-bekliyor { background-color: #ffc107 !important; color: #212529 !important; } /* Yellow/Warning */
.status-giriÅŸ-yaptÄ± { background-color: #0d6efd !important; } /* Blue/Primary */
.status-Ã§Ä±kÄ±ÅŸ-yaptÄ±, .status-iptal { background-color: #dc3545 !important; } /* Red/Danger */

/* Oda SeÃ§im Kutusu Stili (Rezervasyon Tablosu Ä°Ã§in) */
.form-select-sm {
    max-width: 120px;
    font-size: 0.75rem;
}

/* Takvim Stilleri (Eski koddan kalma, sadece bakÄ±m iÃ§in tutuldu) */
#roomCalendarContainer table {
    min-width: 1000px; /* Yatay kaydÄ±rma iÃ§in minimum geniÅŸlik */
    border-collapse: collapse;  
    text-align: center;
    font-size: 0.85rem;
}
#roomCalendarContainer th {
    background-color: #f7f7f7;
    padding: 6px;
    font-weight: 600;
}
#roomCalendarContainer td {
    padding: 4px;
    border: 1px solid #dee2e6;  
    vertical-align: middle;
    height: 35px;  
}

.bg-danger-subtle { background-color: #f8d7da !important; color: #721c24; }
.bg-danger { background-color: #dc3545 !important; color: #fff; } 
.bg-light-subtle { background-color: #e9ecef !important; } /* Hafta sonu gri */

/* Buton GruplarÄ± ArasÄ±ndaki BoÅŸluk */
.action-buttons > * {
    margin-right: 0.25rem;
}

/* ğŸ† YAT KULÃœBÃœ SATIRI Ä°Ã‡Ä°N EK STÄ°L (Takvim) ğŸ† */
/* Bu stil, API'den gelen veri iÃ§inde en son satÄ±rÄ±n YAT KULÃœBÃœ satÄ±rÄ± olduÄŸu varsayÄ±mÄ±yla Ã§alÄ±ÅŸÄ±r. */
#roomCalendarContainer table tbody tr:last-child td:first-child {
    background-color: #b2ebf2 !important; /* Daha belirgin bir aÃ§Ä±k mavi */
    font-weight: bold;
    color: #006064; /* Koyu turkuaz yazÄ± */
}
</style>

<script>
/* --- approveReservation FONKSÄ°YONU (Mevcut) --- */
function approveReservation(reservationId) {
    const select = document.getElementById(`room-select-${reservationId}`);

    if (!select || select.value === '') {
        alert('LÃ¼tfen rezervasyonu onaylamadan Ã¶nce tablo Ã¼zerindeki Oda SeÃ§ kutusundan bir oda seÃ§in!');
        return;
    }
    
    const roomId = select.value;

    // URL yapÄ±sÄ±, Flask'Ä±n dinamik kÄ±sÄ±mlarÄ±nÄ± dikkate alarak gÃ¼ncellendi
    const urlBase = '{{ url_for("update_reservation_status", reservation_id=0, new_status="OnaylandÄ±") }}';
    const finalUrl = urlBase.replace('/0/', `/${reservationId}/`);
    
    let url = finalUrl + `?room_id=${roomId}`;
    
    if (confirm("SeÃ§ilen odaya atayarak rezervasyonu ONAYLAMAK istediÄŸinizden emin misiniz?")) {
        window.location.href = url;
    }
}


/* --- Takvim JS (YAT KULÃœBÃœ SATIRI EKLENDÄ°) --- */
let currentYear;
let currentMonth;

function renderCalendar(year, month) {
    const monthNames = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
    
    document.getElementById('currentMonthYear').textContent = `${monthNames[month - 1]} ${year}`;
    
    const container = document.getElementById('roomCalendarContainer');
    container.innerHTML = '<div class="alert alert-info" role="alert">Takvim verileri yÃ¼kleniyor...</div>';
    
    const apiUrlBase = '{{ url_for("takvim_doluluk_oda_api", year=0, month=0) }}';
    const apiUrl = apiUrlBase.replace('/0/0', `/${year}/${month}`);

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {

            if (data.error) {
                container.innerHTML = `<div class="alert alert-danger" role="alert">Hata: ${data.error}</div>`;
                return;
            }

            container.innerHTML = ''; 
            
            if (!data || data.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning" role="alert">Bu ay iÃ§in veritabanÄ±nda tanÄ±mlÄ± oda bulunamadÄ± veya takvim verisi gelmedi.</div>';
                    return;
            }

            const daysInMonth = new Date(year, month, 0).getDate();
            const dayHeaders = ['Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt', 'Paz'];

            let headerHtml = `<table class="table table-bordered table-sm table-fixed"><thead><tr><th style="width:150px;">Oda No / Tipi</th>`;
            
            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month - 1, i);
                const dayIndex = (date.getDay() + 6) % 7; // Pzt=0, Paz=6
                const isWeekend = dayIndex >= 5;  
                headerHtml += `<th class="text-center p-1 ${isWeekend ? 'bg-light-subtle' : ''}">${i}<br><small>${dayHeaders[dayIndex]}</small></th>`;
            }
            headerHtml += `</tr></thead><tbody>`;

            let bodyHtml = '';
            
            data.forEach(roomData => {
                bodyHtml += `<tr><td class="font-weight-bold">${roomData.oda}</td>`;
                
                roomData.gunler.forEach(day => {
                    let bgColor = '';  
                    let tooltipText = day.durum === 'dolu' ? `Rezervasyonlu: ${day.rez_id}` : 'MÃ¼sait';

                    const dayDate = new Date(year, month - 1, day.gun);
                    const dayIndex = (dayDate.getDay() + 6) % 7;
                    
                    if (day.durum === 'dolu') {
                        bgColor = 'bg-danger';  
                    } else {
                        if (dayIndex >= 5) {
                            bgColor = 'bg-light-subtle';
                        }
                    }
                    
                    bodyHtml += `<td class="text-center p-1 ${bgColor}" title="${tooltipText}"></td>`;
                });
                bodyHtml += `</tr>`;
            });
            
            let footerHtml = `</tbody></table>`;

            container.innerHTML = headerHtml + bodyHtml + footerHtml;

        })
        .catch(error => {
            console.error('Takvim verisi Ã§ekilirken hata:', error);
            container.innerHTML = `<div class="alert alert-danger" role="alert">Veri Ã§ekme hatasÄ±: Sunucuya eriÅŸilemiyor veya API hatasÄ±. (Konsolu kontrol edin)</div>`;
        });
}

// Navigasyon FonksiyonlarÄ± (Mevcut)
function changeMonth(delta) {
    currentMonth += delta;
    if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
    } else if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
    }
    renderCalendar(currentYear, currentMonth);
}

// Sekme ve BaÅŸlangÄ±Ã§ta Ã§alÄ±ÅŸtÄ±rma (Mevcut)
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    currentYear = today.getFullYear();
    currentMonth = today.getMonth() + 1;

    // Sekme deÄŸiÅŸtirildiÄŸinde takvimi yÃ¼kle
    const calendarTab = document.getElementById('calendar-tab');
    calendarTab.addEventListener('click', function() {
        if (currentYear && currentMonth) { // YÃ¼kleme durumu kontrolÃ¼
            renderCalendar(currentYear, currentMonth);
        }
    });

    document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
    document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

    // BaÅŸlangÄ±Ã§ta aktif sekmeyi kontrol et
    const activeTab = document.querySelector('.nav-tabs .nav-link.active');
    if(activeTab && activeTab.getAttribute('href') === '#calendar') {
        renderCalendar(currentYear, currentMonth);
    }
});
</script>

{% endblock content %}